CC=gcc
PROG:={{SERVER_NAME}}
KERNEL_LINUX_VER:={{LINUX_VER}}
VERSION={{VERSION}}
EPOLL_COMPAT_KERNEL:={{EPOLL_COMPAT_KERNEL}}
ASAN_CFLAGS=-fsanitize=address
OPTIMIZATION=-O2  -floop-unroll-and-jam -funswitch-loops -fvect-cost-model=dynamic -D_RELEASE_BUILD=1 
DEBUG=-O0 -g -ggdb3 -D_DEBUG_BUILD=1
FOLDER_SRC={{SOURCE_CODE_FOLDER}}
DEFAULT_ROOT_FOLDER={{DEFAULT_ROOT_FOLDER}}
DEFAULT_ADDR=127.0.0.1
DEFAULT_PORT=8080
HAS_SSE={{HAS_SSE}}
HAS_AVX={{HAS_AVX}}
CFLAGS+= -Wno-discarded-qualifiers $({{BUILD_TYPE}}) -DPROG_NAME=\"$(PROG)\" -DDEFAULT_ROOT_FOLDER=\"$(DEFAULT_ROOT_FOLDER)\" -DDEFAULT_ADDR=\"$(DEFAULT_ADDR)\" -DDEFAULT_PORT=\"$(DEFAULT_PORT)\" -DVERSION=\"$(VERSION)\"  -DLINUX_KERNEL_VERSION=\"$(KERNEL_LINUX_VER)\" -DEPOLL_COMPAT_KERNEL=\"$(EPOLL_COMPAT_KERNEL)\" -DEB_HAS_SSE=$(HAS_SSE) -DEB_HAS_AVX=$(HAS_AVX) -Wno-attributes

LFLAGS+= -lrt -lm -std=gnu11 {{DEBUG_TYPE}}

all: $(PROG)

$(PROG): $(FOLDER_SRC)/main.c $(FOLDER_SRC)/coragem.c $(FOLDER_SRC)/allocator.c $(FOLDER_SRC)/util.c $(FOLDER_SRC)/os.c $(FOLDER_SRC)/event.c $(FOLDER_SRC)/timer.c
	$(CC) $(ASAN_CFLAGS) $(CFLAGS) $^ -o $@ $(LFLAGS)

test: $(FOLDER_SRC)/test.c $(FOLDER_SRC)/util.c $(FOLDER_SRC)/allocator.c $(FOLDER_SRC)/os.c $(FOLDER_SRC)/timer.c
	$(CC) $(ASAN_CFLAGS) $(CFLAGS) $^ -o $@ $(LFLAGS)

.PHONY: all clean
clean:
	rm -f *.o $(PROG)	test
